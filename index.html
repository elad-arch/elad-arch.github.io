<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>המצפן הפיננסי</title>
    <link rel="icon" href="favicon.svg" type="image/svg+xml">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Rubik:wght@400;600;700&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        :root {
            --bg-gradient-start: #f5f7fa;
            --bg-gradient-end: #eef2f3;
            --card-bg: #ffffff;
            --text-primary: #1f2937;
            --text-secondary: #6b7280;
            --header-text-color: #1f2937;
            --border-color: #f0f0f0;
            --item-bg: #f9fafb;
            --item-hover: #f3f4f6;
            --modal-overlay: rgba(0,0,0,0.5);
        }

        [data-theme="dark"] {
            --bg-gradient-start: #1e293b;
            --bg-gradient-end: #0f172a;
            --card-bg: #1e293b;
            --text-primary: #f1f5f9;
            --text-secondary: #94a3b8;
            --header-text-color: #f1f5f9;
            --border-color: #334155;
            --item-bg: #334155;
            --item-hover: #475569;
            --modal-overlay: rgba(0,0,0,0.7);
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Rubik', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            background: linear-gradient(135deg, var(--bg-gradient-start) 0%, var(--bg-gradient-end) 100%);
            min-height: 100vh;
            padding: 20px;
            transition: background 0.3s ease;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
        }

        .header {
            text-align: center;
            color: var(--header-text-color);
            margin-bottom: 30px;
        }

        .header h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 12px;
            transition: text-shadow 0.4s ease;
        }

        .header h1.title-positive-balance {
            text-shadow: 0 0 12px rgba(16, 185, 129, 0.8);
        }
        .header h1.title-negative-balance {
            text-shadow: 0 0 12px rgba(239, 68, 68, 0.8);
        }

        .balance-indicator-container {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 15px;
            width: 100%;
            max-width: 400px;
            margin: 10px auto 25px;
            color: var(--header-text-color);
            font-weight: 600;
            font-size: 14px;
        }
        .balance-scale {
            flex-grow: 1;
            height: 12px;
            background: linear-gradient(to right, #ef4444, #10b981);
            border-radius: 6px;
            position: relative;
            box-shadow: inset 0 1px 3px rgba(0,0,0,0.2);
        }
        .balance-indicator {
            position: absolute;
            top: 50%;
            width: 24px;
            height: 24px;
            background: var(--card-bg);
            border-radius: 50%;
            border: 3px solid #8b5cf6;
            transform: translate(-50%, -50%);
            transition: left 0.5s ease-in-out;
            box-shadow: 0 2px 6px rgba(0,0,0,0.3);
        }

        .balance-label {
            display: flex;
            align-items: center;
            gap: 6px;
            font-weight: 600;
        }
        .balance-label.expenses {
            color: #ef4444;
        }
        .balance-label.income {
            color: #10b981;
        }
        .balance-label svg {
            width: 20px;
            height: 20px;
        }

        .controls {
            display: flex;
            gap: 10px;
            justify-content: center;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }

        .btn {
            padding: 12px 24px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 16px;
            font-weight: 600;
            transition: all 0.3s;
            display: flex;
            align-items: center;
        }

        .btn svg {
            width: 20px;
            height: 20px;
        }

        .btn-export {
            background: #10b981;
            color: white;
            padding: 10px 20px;
            border-radius: 9999px;
            gap: 8px;
        }

        .btn-import {
            background: #3b82f6;
            color: white;
            padding: 10px 20px;
            border-radius: 9999px;
            gap: 8px;
        }

        .btn-theme {
            background: #8b5cf6;
            color: white;
            width: 48px;
            height: 48px;
            padding: 0;
            border-radius: 50%;
            display: flex;
            justify-content: center;
            align-items: center;
            border: none;
            cursor: pointer;
            transition: all 0.3s;
        }

        .btn:hover, .btn-theme:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.2);
        }

        .main-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-bottom: 20px;
            align-items: start;
        }

        .card {
            background: var(--card-bg);
            border-radius: 16px;
            padding: 24px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.1);
            transition: background 0.3s ease;
            display: flex;
            flex-direction: column;
        }

        .card-header {
            display: flex;
            flex-direction: column;
            gap: 16px;
            margin-bottom: 20px;
            padding-bottom: 16px;
            border-bottom: 2px solid var(--border-color);
        }

        .card.is-collapsed .card-header {
            margin-bottom: 0;
            padding-bottom: 0;
            border-bottom: none;
        }

        .card-title-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .card-title {
            font-size: 1.5em;
            font-weight: 700;
            display: flex;
            align-items: center;
            gap: 10px;
            color: var(--text-primary);
        }

        .card-title svg {
             width: 28px;
             height: 28px;
        }

        .income-card .card-title svg {
            color: #10b981;
        }

        .expense-card .card-title svg {
            color: #ef4444;
        }
        
        .summary-card .card-title svg {
             color: #f59e0b;
        }

        .header-actions {
            display: flex;
            gap: 8px;
            justify-content: center;
            position: relative;
        }

        .card.is-collapsed .header-actions {
            display: none;
        }

        .add-btn, .chart-btn, .edit-mode-btn, .filter-btn, .sort-mode-btn {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            border: none;
            cursor: pointer;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .income-card .add-btn {
            background: #d1fae5;
            color: #10b981;
        }

        .expense-card .add-btn {
            background: #fee2e2;
            color: #ef4444;
        }

        .income-card .chart-btn {
            background: #d1fae5;
            color: #10b981;
        }

        .expense-card .chart-btn {
            background: #fee2e2;
            color: #ef4444;
        }

        .income-card .filter-btn {
            background: #d1fae5;
            color: #10b981;
        }

        .expense-card .filter-btn {
            background: #fee2e2;
            color: #ef4444;
        }

        .income-card .sort-mode-btn {
            background: #d1fae5;
            color: #10b981;
        }

        .expense-card .sort-mode-btn {
            background: #fee2e2;
            color: #ef4444;
        }

        .income-card .filter-btn.active {
            background: #10b981;
            color: white;
        }

        .expense-card .filter-btn.active {
            background: #ef4444;
            color: white;
        }

        .income-card .sort-mode-btn.active {
            background: #10b981;
            color: white;
        }

        .expense-card .sort-mode-btn.active {
            background: #ef4444;
            color: white;
        }

        .add-btn:hover, .chart-btn:hover, .filter-btn:hover, .sort-mode-btn:hover {
            transform: scale(1.1);
        }

        .add-btn:disabled, .chart-btn:disabled, .sort-mode-btn:disabled,
        .add-btn:disabled:hover, .chart-btn:disabled:hover, .sort-mode-btn:disabled:hover {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none;
            background: #e5e7eb;
            color: #9ca3af;
        }

        [data-theme="dark"] .add-btn:disabled, 
        [data-theme="dark"] .chart-btn:disabled, 
        [data-theme="dark"] .sort-mode-btn:disabled,
        [data-theme="dark"] .add-btn:disabled:hover, 
        [data-theme="dark"] .chart-btn:disabled:hover, 
        [data-theme="dark"] .sort-mode-btn:disabled:hover {
            background: #334155;
            color: #64748b;
        }

        .transaction-list {
            display: flex;
            flex-direction: column;
            gap: 12px;
            margin-bottom: 20px;
            min-height: 200px;
            flex: 1;
        }

        .transaction-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 16px;
            transition: all 0.3s;
        }

        .transaction-item:hover {
            transform: none;
        }

        .transaction-item.inactive .transaction-info,
        .transaction-item.inactive .transaction-amount {
            opacity: 0.6;
            transition: opacity 0.3s ease;
        }

        .transaction-info {
            display: flex;
            align-items: center;
            gap: 12px;
            flex: 1;
            min-width: 150px;
        }

        .transaction-check {
            width: 24px;
            height: 24px;
            border-radius: 6px;
            border: 2px solid #d1d5db;
            cursor: pointer;
            transition: all 0.3s;
            flex-shrink: 0;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
        }

        .transaction-check svg {
            width: 18px;
            height: 18px;
            opacity: 0;
            transform: scale(0.5);
            transition: all 0.2s ease-in-out;
        }

        .transaction-check.checked svg {
            opacity: 1;
            transform: scale(1);
        }

        .income-card .transaction-check.checked {
            background: #10b981;
            border-color: #10b981;
        }

        .expense-card .transaction-check.checked {
            background: #ef4444;
            border-color: #ef4444;
        }

        .transaction-details {
            display: flex;
            flex-direction: column;
            gap: 4px;
        }

        .transaction-text {
            flex: 1;
            font-size: 16px;
            color: var(--text-primary);
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .loan-original-amount {
            font-size: 12px;
            color: var(--text-secondary);
            font-weight: 500;
            opacity: 0.9;
            font-style: italic;
        }

        .transaction-wrapper {
            display: flex;
            flex-direction: column;
            background: var(--item-bg);
            border-radius: 12px;
            transition: all 0.3s;
        }

        .transaction-wrapper:hover {
            background: var(--item-hover);
        }

        .transaction-item.loan-item {
            cursor: pointer;
        }

        .transaction-badge {
            display: inline-flex;
            align-items: center;
            padding: 4px 10px;
            border-radius: 9999px; /* This creates the pill shape */
            font-size: 12px;
            font-weight: 600;
            line-height: 1;
        }

        .badge-regular {
            background: #ccfbf1;
            color: #134e4a;
        }

        .badge-onetime {
            background: #e0e7ff;
            color: #3730a3;
        }

        .badge-loan {
            background: #fee2e2;
            color: #991b1b;
        }

        .badge-variable {
            background: #fef9c3;
            color: #854d0e;
        }

        .loan-progress {
            width: 100%;
            padding: 0 16px;
            display: flex;
            align-items: center;
            gap: 12px;
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.4s ease-out, padding 0.4s ease-out;
        }

        .loan-progress.visible {
            max-height: 100px;
            padding: 8px 16px 16px 16px;
        }

        .loan-progress-container {
            flex: 1;
        }

        .loan-next-payment-btn {
            width: 28px;
            height: 28px;
            padding: 0;
            background: #f97316;
            color: white;
            border: none;
            border-radius: 50%;
            cursor: pointer;
            transition: all 0.3s;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            flex-shrink: 0;
        }

        .loan-next-payment-btn svg {
            width: 16px;
            height: 16px;
        }

        .loan-next-payment-btn:hover {
            background: #ea580c;
            transform: scale(1.05);
        }

        .loan-next-payment-btn:disabled {
            background: #d1d5db;
            cursor: not-allowed;
            opacity: 0.5;
        }

        .loan-next-payment-btn:disabled:hover {
            transform: none;
        }

        .progress-bar-container {
            width: 100%;
            height: 20px;
            background: #e5e7eb;
            border-radius: 10px;
            overflow: hidden;
            position: relative;
        }

        .progress-bar-fill {
            height: 100%;
            background: linear-gradient(90deg, #f97316, #facc15);
            transition: width 0.3s ease;
        }

        .progress-text {
            font-size: 11px;
            color: #6b7280;
            text-align: center;
            margin-top: 4px;
            font-weight: 600;
        }

        .transaction-amount {
            font-size: 18px;
            font-weight: 700;
            margin-left: 16px;
        }
        
        .income-card .transaction-amount {
            color: #10b981;
        }

        .expense-card .transaction-amount {
            color: #ef4444;
        }

        .transaction-actions {
            display: flex;
            gap: 8px;
        }

        .item-controls {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-left: 8px;
        }

        .sort-buttons {
            display: none;
            gap: 4px;
        }

        .sort-buttons.visible {
            display: flex;
        }

        .sort-btn {
            width: 32px;
            height: 32px;
            border: none;
            border-radius: 50%;
            cursor: pointer;
            background: transparent;
            color: var(--text-secondary);
            transition: all 0.3s;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .sort-btn:hover {
            background-color: #e0e7ff;
            color: #4f46e5;
            transform: scale(1.1);
        }

        .sort-btn:disabled {
            background: transparent;
            cursor: not-allowed;
            opacity: 0.5;
            color: var(--text-secondary);
        }

        .sort-btn:disabled:hover {
            background-color: transparent;
            color: var(--text-secondary);
            transform: none;
        }

        .action-btn {
            width: 32px;
            height: 32px;
            border: none;
            border-radius: 50%;
            cursor: pointer;
            background: transparent;
            color: var(--text-secondary);
            transition: all 0.3s;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .action-btn:hover {
            transform: scale(1.1);
        }

        .action-btn.edit:hover {
            background-color: #e0e7ff;
            color: #4f46e5;
        }
        
        .action-btn.delete:hover {
            background-color: #fee2e2;
            color: #ef4444;
        }

        .collapse-btn svg {
             transition: transform 0.3s ease-in-out;
        }

        .collapse-btn.collapsed svg {
            transform: rotate(-180deg);
        }

        .card-footer {
            padding-top: 20px;
            border-top: 2px solid var(--border-color);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .total-label {
            font-size: 16px;
            font-weight: 600;
            color: var(--text-primary);
            opacity: 0.8;
        }

        .total-amount {
            font-size: 28px;
            font-weight: 700;
        }

        .income-card .total-amount {
            color: #10b981;
        }

        .expense-card .total-amount {
            color: #ef4444;
        }

        .summary-card, .loans-summary-card {
            background: var(--card-bg);
            border-radius: 16px;
            padding: 24px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.1);
            transition: all 0.3s ease;
        }

        .summary-card.alert-danger {
            background: linear-gradient(135deg, #fef2f2 0%, #fee2e2 100%);
            border: 2px solid #fca5a5;
        }

        .summary-card.alert-warning {
            background: linear-gradient(135deg, #fffbeb 0%, #fef3c7 100%);
            border: 2px solid #fbbf24;
        }

        .summary-card.alert-success {
            background: linear-gradient(135deg, #f0fdf4 0%, #dcfce7 100%);
            border: 2px solid #4ade80;
        }

        .loans-summary-card {
            background: linear-gradient(135deg, #ede9fe 0%, #ddd6fe 100%);
            border: 2px solid #c4b5fd;
            margin-bottom: 20px;
        }

        [data-theme="dark"] .summary-card.alert-danger {
            background: linear-gradient(135deg, #3f2222 0%, #4c1d1d 100%);
            border-color: #7f1d1d;
        }

        [data-theme="dark"] .summary-card.alert-warning {
            background: linear-gradient(135deg, #422c0b 0%, #4a2e0a 100%);
            border-color: #78350f;
        }

        [data-theme="dark"] .summary-card.alert-success {
            background: transparent;
            border-color: #22c55e;
        }

        [data-theme="dark"] .loans-summary-card {
            background: linear-gradient(135deg, #2e2154 0%, #3b2d69 100%);
            border-color: #5b21b6;
        }

        .loans-summary-card .card-title svg {
            color: #7c3aed;
        }

        [data-theme="dark"] .loans-summary-card .card-title svg {
            color: #a78bfa;
        }

        .summary-row-value.loan-value {
            color: #6d28d9;
        }

        [data-theme="dark"] .summary-row-value.loan-value {
            color: #c4b5fd;
        }

        .alert-icon {
            text-align: center;
            margin-bottom: 16px;
        }

        .alert-icon svg {
            width: 48px;
            height: 48px;
        }

        .summary-card.alert-danger .alert-icon {
            color: #ef4444;
        }

        .summary-card.alert-warning .alert-icon {
            color: #f59e0b;
        }

        .summary-card.alert-success .alert-icon {
            color: #059669;
        }

        [data-theme="dark"] .summary-card.alert-danger .alert-icon {
            color: #fca5a5;
        }

        [data-theme="dark"] .summary-card.alert-warning .alert-icon {
            color: #fbbf24;
        }

        [data-theme="dark"] .summary-card.alert-success .alert-icon {
            color: #22c55e;
        }

        .summary-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 16px;
            background: var(--item-bg);
            border-radius: 12px;
            margin-bottom: 12px;
            transition: all 0.3s;
        }

        .summary-row:last-of-type {
            margin-bottom: 20px;
        }

        .loans-summary-card .summary-row:last-of-type {
            margin-bottom: 0;
        }

        .card-body {
            transition: max-height 0.4s ease-out, padding 0.4s ease-out, margin 0.4s ease-out;
            overflow: hidden;
            max-height: 2000px; /* High value to allow for content */
        }

        .card.is-collapsed .card-body {
            max-height: 0;
            padding-top: 0;
            padding-bottom: 0;
            margin-top: 0;
        }

        .card-summary-collapsed {
            display: none;
            padding-top: 16px;
            text-align: center;
        }
        
        .card.is-collapsed .card-summary-collapsed {
            display: block;
        }

        .card-summary-collapsed .summary-label {
            font-size: 1em;
            color: var(--text-secondary);
            margin-left: 8px;
        }
        .card-summary-collapsed .summary-value {
            font-size: 1.5em;
            font-weight: 700;
        }
        .income-card .card-summary-collapsed .summary-value { color: #10b981; }
        .expense-card .card-summary-collapsed .summary-value { color: #ef4444; }
        .loans-summary-card .card-summary-collapsed .summary-value { color: #6d28d9; }
        [data-theme="dark"] .loans-summary-card .card-summary-collapsed .summary-value { color: #c4b5fd; }
        .summary-card .card-summary-collapsed .summary-value.positive { color: #10b981; }
        .summary-card .card-summary-collapsed .summary-value.negative { color: #ef4444; }


        .summary-row-label {
            font-size: 16px;
            font-weight: 600;
            color: var(--text-primary);
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .summary-row-label svg {
            width: 20px;
            height: 20px;
        }
        
        .summary-row-label .positive { color: #10b981; }
        .summary-row-label .negative { color: #ef4444; }

        .summary-row-value {
            font-size: 24px;
            font-weight: 700;
        }

        .summary-row-value.positive {
            color: #10b981;
        }

        .summary-row-value.negative {
            color: #ef4444;
        }

        .summary-row-value.neutral {
            color: var(--text-primary);
        }

        .summary-input {
            font-size: 24px;
            font-weight: 700;
            padding: 8px 12px;
            border: 2px solid var(--border-color);
            border-radius: 8px;
            background: var(--card-bg);
            color: var(--text-primary);
            text-align: left;
            width: 200px;
            transition: all 0.3s;
        }

        .summary-input:focus {
            outline: none;
            border-color: #667eea;
        }

        .summary-input:hover {
            border-color: #667eea;
        }

        .delete-all-container {
            text-align: left;
            padding-top: 12px;
            border-top: 2px solid var(--border-color);
        }

        .btn-delete-all-small {
            padding: 8px 16px;
            background: #ef4444;
            color: white;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 600;
            transition: all 0.3s;
            display: inline-flex;
            align-items: center;
            gap: 6px;
        }

        .btn-delete-all-small:hover {
            background: #dc2626;
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(239, 68, 68, 0.3);
        }

        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: var(--modal-overlay);
            z-index: 1000;
            align-items: center;
            justify-content: center;
        }

        .modal.active {
            display: flex;
        }

        .modal-content {
            background: var(--card-bg);
            border-radius: 16px;
            padding: 32px;
            width: 90%;
            max-width: 500px;
            max-height: 90vh;
            overflow-y: auto;
        }

        .modal-header {
            font-size: 24px;
            font-weight: 700;
            margin-bottom: 24px;
            text-align: center;
            color: var(--text-primary);
        }

        .form-group {
            margin-bottom: 20px;
        }

        .transaction-type-selector {
            display: flex;
            gap: 12px;
            margin-bottom: 20px;
        }

        .type-option {
            flex: 1;
            padding: 12px;
            border: 2px solid var(--border-color);
            border-radius: 8px;
            cursor: pointer;
            text-align: center;
            transition: all 0.3s;
            background: var(--card-bg);
            color: var(--text-primary);
            font-weight: 600;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }
        
        .type-option svg {
            width: 18px;
            height: 18px;
        }

        .type-option:hover {
            border-color: #667eea;
        }

        .type-option.selected {
            border-color: #667eea;
            background: #667eea;
            color: white;
        }

        .type-option.disabled {
            opacity: 0.5;
            cursor: not-allowed;
            background: #e5e7eb;
            border-color: #d1d5db;
            color: #9ca3af;
        }

        .type-option.disabled:hover {
            border-color: #d1d5db;
            transform: none;
        }

        .loan-fields {
            display: none;
            flex-direction: column;
            gap: 12px;
            margin-top: 16px;
        }

        .loan-fields.active {
            display: flex;
        }

        .loan-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 12px;
        }

        .form-label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: var(--text-primary);
        }

        .form-input {
            width: 100%;
            padding: 12px;
            border: 2px solid var(--border-color);
            border-radius: 8px;
            font-size: 16px;
            transition: all 0.3s;
            background: var(--card-bg);
            color: var(--text-primary);
        }

        .form-input:focus {
            outline: none;
            border-color: #667eea;
        }

        .modal-actions {
            display: flex;
            gap: 12px;
            margin-top: 24px;
        }

        .modal-btn {
            flex: 1;
            padding: 12px;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
        }

        .modal-btn-save {
            background: #10b981;
            color: white;
        }

        .modal-btn-cancel {
            background: #e5e7eb;
            color: #374151;
        }

        #confirmModalConfirmBtn {
            background-color: #ef4444;
            color: white;
        }

        #confirmModalText {
            margin: 20px 0; 
            color: var(--text-primary); 
            text-align: center; 
            line-height: 1.6;
        }

        .modal-btn:hover {
            transform: translateY(-2px);
        }

        .dropdown-container {
            position: relative;
            display: inline-block;
        }

        .filter-dropdown {
            display: none;
            position: absolute;
            top: calc(100% + 10px);
            left: 50%;
            transform: translateX(-50%);
            background: var(--card-bg);
            border: 2px solid var(--border-color);
            border-radius: 12px;
            box-shadow: 0 8px 24px rgba(0,0,0,0.2);
            z-index: 1000;
            min-width: 200px;
            padding: 8px;
        }

        .filter-dropdown.active {
            display: block;
        }

        .filter-option {
            padding: 10px 12px;
            cursor: pointer;
            border-radius: 8px;
            transition: all 0.2s;
            color: var(--text-primary);
            font-size: 14px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .filter-option svg {
             width: 16px;
             height: 16px;
        }

        .filter-option:hover {
            background: var(--item-hover);
        }

        .filter-option.selected {
            background: #667eea;
            color: white;
            font-weight: 600;
        }

        .empty-state {
            text-align: center;
            padding: 40px 20px;
            color: var(--text-secondary);
        }

        .chart-container {
            position: relative;
            height: 400px;
            margin-top: 20px;
        }

        @media (max-width: 768px) {
            .main-grid {
                grid-template-columns: 1fr;
            }

            .header h1 {
                font-size: 1.8em;
            }

            .summary-input {
                width: 150px;
                font-size: 20px;
            }

            /* Specific styles for the main summary card on mobile */
            .summary-card .summary-row {
                flex-direction: column;
                align-items: flex-start;
                gap: 12px;
            }

            .summary-card .summary-row-value,
            .summary-card .summary-input {
                width: 100%;
            }

            /* Adjustments for the loans summary card to match forecast card on mobile */
            .loans-summary-card .summary-row {
                flex-direction: column;
                align-items: flex-start;
                gap: 12px;
            }

            .loans-summary-card .summary-row-value {
                width: 100%;
            }

            .chart-container {
                height: 300px;
            }

            .transaction-item {
                flex-wrap: wrap;
                row-gap: 8px;
            }

            .transaction-info {
                flex-grow: 1;
            }

            .transaction-amount {
                margin-left: 0;
            }

            .item-controls {
                flex-basis: 100%;
                justify-content: flex-end;
                margin-top: 8px;
                padding-top: 8px;
                margin-left: 0;
                border-top: 1px solid var(--border-color);
            }

            .transaction-type-selector {
                flex-wrap: wrap;
            }

            .type-option {
                flex-basis: calc(50% - 6px);
            }
        }

        input[type="file"] {
            display: none;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>
                <svg xmlns="http://www.w3.org/2000/svg" width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"></circle><polygon points="16.24 7.76 14.12 14.12 7.76 16.24 9.88 9.88 16.24 7.76"></polygon></svg>
                המצפן הפיננסי
            </h1>
            <div class="balance-indicator-container">
                <div class="balance-label income">
                    <span>הכנסות</span>
                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><line x1="12" y1="19" x2="12" y2="5"></line><polyline points="5 12 12 5 19 12"></polyline></svg>
                </div>
                <div class="balance-scale">
                    <div class="balance-indicator" id="balanceIndicator"></div>
                </div>
                <div class="balance-label expenses">
                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><line x1="12" y1="5" x2="12" y2="19"></line><polyline points="19 12 12 19 5 12"></polyline></svg>
                    <span>הוצאות</span>
                </div>
            </div>
            <div class="controls">
                <button class="btn-theme" onclick="cycleTheme()" id="themeBtn" title="שנה ערכת נושא">
                     <span id="themeIconContainer"></span>
                </button>
                <button class="btn btn-export" onclick="exportData()" title="ייצוא נתונים">
                    <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="7 10 12 15 17 10"/><line x1="12" y1="15" x2="12" y2="3"/></svg>
                    ייצוא נתונים
                </button>
                <button class="btn btn-import" onclick="document.getElementById('importFile').click()" title="ייבוא נתונים">
                     <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="17 8 12 3 7 8"/><line x1="12" y1="3" x2="12" y2="15"/></svg>
                     ייבוא נתונים
                </button>
                <input type="file" id="importFile" accept=".json" onchange="importData(event)">
            </div>
        </div>

        <div class="main-grid">
            <!-- הכנסות -->
            <div class="card income-card">
                <div class="card-header">
                    <div class="card-title-row">
                        <div class="card-title">
                            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="12" y1="20" x2="12" y2="4"></line><polyline points="18 10 12 4 6 10"></polyline></svg>
                            הכנסות חודשיות
                        </div>
                         <button class="action-btn collapse-btn" onclick="toggleCard(this, 'income')" title="מזער/הרחב">
                            <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><polyline points="18 15 12 9 6 15"></polyline></svg>
                        </button>
                    </div>
                     <div class="card-summary-collapsed" id="incomeCollapsedSummary"></div>
                    <div class="header-actions">
                        <div class="dropdown-container">
                            <button class="filter-btn" id="filterBtnIncome" onclick="toggleFilter('income')" title="סינון">
                                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="4" y1="21" x2="4" y2="14"></line><line x1="4" y1="10" x2="4" y2="3"></line><line x1="12" y1="21" x2="12" y2="12"></line><line x1="12" y1="8" x2="12" y2="3"></line><line x1="20" y1="21" x2="20" y2="16"></line><line x1="20" y1="12" x2="20" y2="3"></line><line x1="1" y1="14" x2="7" y2="14"></line><line x1="9" y1="8" x2="15" y2="8"></line><line x1="17" y1="16" x2="23" y2="16"></line></svg>
                            </button>
                            <div class="filter-dropdown" id="filterDropdownIncome">
                                <div class="filter-option selected" data-filter="all" onclick="setFilter('income', 'all')"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M16 4h2a2 2 0 0 1 2 2v14a2 2 0 0 1-2 2H6a2 2 0 0 1-2-2V6a2 2 0 0 1 2-2h2"></path><rect x="8" y="2" width="8" height="4" rx="1" ry="1"></rect></svg> הצג הכל</div>
                                <div class="filter-option" data-filter="active" onclick="setFilter('income', 'active')"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M9 11l3 3L22 4"/><path d="M21 12v7a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11"/></svg> תנועות פעילות</div>
                                <div class="filter-option" data-filter="inactive" onclick="setFilter('income', 'inactive')"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="3" y="3" width="18" height="18" rx="2" ry="2"></rect></svg> תנועות לא פעילות</div>
                                <div class="filter-option" data-filter="regular" onclick="setFilter('income', 'regular')"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21.5 2v6h-6M2.5 22v-6h6M2 11.5a10 10 0 0 1 18.8-4.3M22 12.5a10 10 0 0 1-18.8 4.2"/></svg> קבועות</div>
                                <div class="filter-option" data-filter="variable" onclick="setFilter('income', 'variable')"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M3 3v18h18"/><path d="m19 9-5 5-4-4-3 3"/></svg> משתנות</div>
                                <div class="filter-option" data-filter="onetime" onclick="setFilter('income', 'onetime')"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polygon points="13 2 3 14 12 14 11 22 21 10 12 10 13 2"></polygon></svg> חד-פעמיות</div>
                            </div>
                        </div>
                        <button class="sort-mode-btn" id="sortBtnIncome" onclick="toggleSortMode('income')" title="סידור">
                            <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="m3 16 4 4 4-4"/><path d="M7 20V4"/><path d="m21 8-4-4-4 4"/><path d="M17 4v16"/></svg>
                        </button>
                        <button class="chart-btn" onclick="showChart('income')" title="הצג גרף">
                            <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21.21 15.89A10 10 0 1 1 8 2.83"/><path d="M22 12A10 10 0 0 0 12 2v10z"/></svg>
                        </button>
                        <button class="add-btn" onclick="openModal('income')">
                            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3" stroke-linecap="round" stroke-linejoin="round"><line x1="12" y1="5" x2="12" y2="19"></line><line x1="5" y1="12" x2="19" y2="12"></line></svg>
                        </button>
                    </div>
                </div>
                <div class="card-body" id="incomeCardBody">
                    <div class="transaction-list" id="incomeList"></div>
                    <div class="card-footer">
                        <span class="total-label" id="incomeTotalLabel">סה״כ הכנסות</span>
                        <span class="total-amount" id="incomeTotal">₪0</span>
                    </div>
                </div>
            </div>

            <!-- הוצאות -->
            <div class="card expense-card">
                <div class="card-header">
                    <div class="card-title-row">
                        <div class="card-title">
                            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="12" y1="4" x2="12" y2="20"></line><polyline points="18 14 12 20 6 14"></polyline></svg>
                            הוצאות חודשיות
                        </div>
                        <button class="action-btn collapse-btn" onclick="toggleCard(this, 'expense')" title="מזער/הרחב">
                            <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><polyline points="18 15 12 9 6 15"></polyline></svg>
                        </button>
                    </div>
                    <div class="card-summary-collapsed" id="expenseCollapsedSummary"></div>
                    <div class="header-actions">
                        <div class="dropdown-container">
                            <button class="filter-btn" id="filterBtnExpense" onclick="toggleFilter('expense')" title="סינון">
                                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="4" y1="21" x2="4" y2="14"></line><line x1="4" y1="10" x2="4" y2="3"></line><line x1="12" y1="21" x2="12" y2="12"></line><line x1="12" y1="8" x2="12" y2="3"></line><line x1="20" y1="21" x2="20" y2="16"></line><line x1="20" y1="12" x2="20" y2="3"></line><line x1="1" y1="14" x2="7" y2="14"></line><line x1="9" y1="8" x2="15" y2="8"></line><line x1="17" y1="16" x2="23" y2="16"></line></svg>
                            </button>
                            <div class="filter-dropdown" id="filterDropdownExpense">
                                <div class="filter-option selected" data-filter="all" onclick="setFilter('expense', 'all')"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M16 4h2a2 2 0 0 1 2 2v14a2 2 0 0 1-2 2H6a2 2 0 0 1-2-2V6a2 2 0 0 1 2-2h2"></path><rect x="8" y="2" width="8" height="4" rx="1" ry="1"></rect></svg> הצג הכל</div>
                                <div class="filter-option" data-filter="active" onclick="setFilter('expense', 'active')"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M9 11l3 3L22 4"/><path d="M21 12v7a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11"/></svg> תנועות פעילות</div>
                                <div class="filter-option" data-filter="inactive" onclick="setFilter('expense', 'inactive')"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="3" y="3" width="18" height="18" rx="2" ry="2"></rect></svg> תנועות לא פעילות</div>
                                <div class="filter-option" data-filter="regular" onclick="setFilter('expense', 'regular')"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21.5 2v6h-6M2.5 22v-6h6M2 11.5a10 10 0 0 1 18.8-4.3M22 12.5a10 10 0 0 1-18.8 4.2"/></svg> קבועות</div>
                                <div class="filter-option" data-filter="variable" onclick="setFilter('expense', 'variable')"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M3 3v18h18"/><path d="m19 9-5 5-4-4-3 3"/></svg> משתנות</div>
                                <div class="filter-option" data-filter="onetime" onclick="setFilter('expense', 'onetime')"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polygon points="13 2 3 14 12 14 11 22 21 10 12 10 13 2"></polygon></svg> חד-פעמיות</div>
                                <div class="filter-option" data-filter="loan" onclick="setFilter('expense', 'loan')"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="2" y="4" width="20" height="16" rx="2"/><line x1="6" y1="12" x2="18" y2="12"/></svg> הלוואות</div>
                            </div>
                        </div>
                        <button class="sort-mode-btn" id="sortBtnExpense" onclick="toggleSortMode('expense')" title="סידור">
                            <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="m3 16 4 4 4-4"/><path d="M7 20V4"/><path d="m21 8-4-4-4 4"/><path d="M17 4v16"/></svg>
                        </button>
                        <button class="chart-btn" onclick="showChart('expense')" title="הצג גרף">
                            <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21.21 15.89A10 10 0 1 1 8 2.83"/><path d="M22 12A10 10 0 0 0 12 2v10z"/></svg>
                        </button>
                        <button class="add-btn" onclick="openModal('expense')">
                            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3" stroke-linecap="round" stroke-linejoin="round"><line x1="12" y1="5" x2="12" y2="19"></line><line x1="5" y1="12" x2="19" y2="12"></line></svg>
                        </button>
                    </div>
                </div>
                <div class="card-body" id="expenseCardBody">
                    <div class="transaction-list" id="expenseList"></div>
                    <div class="card-footer">
                        <span class="total-label" id="expenseTotalLabel">סה״כ הוצאות</span>
                        <span class="total-amount" id="expenseTotal">₪0</span>
                    </div>
                </div>
            </div>
        </div>

        <!-- הלוואות -->
        <div class="card loans-summary-card">
            <div class="card-header" style="border-bottom: none; margin-bottom: 0; padding-bottom: 0;">
                 <div class="card-title-row">
                    <div class="card-title">
                        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="2" y="4" width="20" height="16" rx="2"></rect><line x1="6" y1="12" x2="18" y2="12"></line></svg>
                        הלוואות
                    </div>
                    <button class="action-btn collapse-btn" onclick="toggleCard(this, 'loansSummary')" title="מזער/הרחב">
                        <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><polyline points="18 15 12 9 6 15"></polyline></svg>
                    </button>
                </div>
                <div class="card-summary-collapsed" id="loansCollapsedSummary"></div>
            </div>
            <div class="card-body" id="loansSummaryCardBody">
                <div id="loansSummaryContent">
                    <div class="summary-row">
                        <div class="summary-row-label">
                            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M16 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"/><circle cx="8.5" cy="7" r="4"/><path d="M20 8v6"/><path d="M23 11h-6"/></svg>
                            סה״כ הלוואות פעילות
                        </div>
                        <div class="summary-row-value loan-value" id="totalLoansCount">0</div>
                    </div>
                    <div class="summary-row">
                        <div class="summary-row-label">
                            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="3" y="4" width="18" height="18" rx="2" ry="2"></rect><line x1="16" y1="2" x2="16" y2="6"></line><line x1="8" y1="2" x2="8" y2="6"></line><line x1="3" y1="10" x2="21" y2="10"></line><path d="M8 14h.01"/><path d="M12 14h.01"/><path d="M16 14h.01"/><path d="M8 18h.01"/><path d="M12 18h.01"/><path d="M16 18h.01"/></svg>
                            סך תשלום ההלוואות בחודש
                        </div>
                        <div class="summary-row-value loan-value" id="monthlyLoanPayment">₪0.00</div>
                    </div>
                    <div class="summary-row">
                        <div class="summary-row-label">
                            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21.21 15.89A10 10 0 1 1 8 2.83"/><path d="M22 12A10 10 0 0 0 12 2v10z"/></svg>
                            סך כל ההלוואות
                        </div>
                        <div class="summary-row-value loan-value" id="totalLoanAmount">₪0.00</div>
                    </div>
                    <div class="summary-row">
                        <div class="summary-row-label">
                            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12 8v4l3 3"/><circle cx="12" cy="12" r="10"/></svg>
                            יתרה לתשלום
                        </div>
                        <div class="summary-row-value loan-value" id="remainingLoanBalance">₪0.00</div>
                    </div>
                </div>
                <div class="empty-state" id="noLoansMessage" style="display: none;">
                    <svg xmlns="http://www.w3.org/2000/svg" width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round" style="color: var(--text-secondary); margin-bottom: 16px;"><path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"></path><polyline points="22 4 12 14.01 9 11.01"></polyline></svg>
                    <p style="color: var(--text-secondary);">אין הלוואות הרשומות במערכת</p>
                </div>
            </div>
        </div>

        <!-- תחזית -->
        <div class="card summary-card">
            <div class="card-header">
                 <div class="card-title-row">
                    <div class="card-title">
                        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="3" y="6" width="18" height="12" rx="2"/><path d="M12 12h.01"/><path d="M6 12h.01"/><path d="M18 12h.01"/></svg>
                        תחזית
                    </div>
                     <button class="action-btn collapse-btn" onclick="toggleCard(this, 'summary')" title="מזער/הרחב">
                        <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><polyline points="18 15 12 9 6 15"></polyline></svg>
                    </button>
                </div>
                <div class="card-summary-collapsed" id="summaryCollapsedSummary"></div>
            </div>
            
            <div class="card-body" id="summaryCardBody">
                 <div id="alertIcon"></div>
                <div class="summary-row">
                    <div class="summary-row-label">
                        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M2 12a10 10 0 1 0 20 0 10 10 0 0 0-20 0Z"/><path d="M12 18a6 6 0 1 0 0-12 6 6 0 0 0 0 12Z"/></svg>
                        עו״ש נוכחי
                    </div>
                    <input type="number" 
                           class="summary-input" 
                           id="currentBalanceInput" 
                           placeholder="0.00" 
                           step="0.01"
                           oninput="updateSummary()">
                </div>

                <div class="summary-row">
                    <div class="summary-row-label">
                        <svg xmlns="http://www.w3.org/2000/svg" class="negative" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M5 12h14"/><path d="m12 5 7 7-7 7"/></svg>
                        עו״ש לאחר הוצאות
                    </div>
                    <div class="summary-row-value neutral" id="balanceAfterExpenses">₪0.00</div>
                </div>

                <div class="summary-row">
                    <div class="summary-row-label">
                        <svg xmlns="http://www.w3.org/2000/svg" class="positive" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="19" y1="12" x2="5" y2="12"></line><polyline points="12 19 5 12 12 5"></polyline></svg>
                        עו״ש סופי (לאחר הכנסות)
                    </div>
                    <div class="summary-row-value neutral" id="finalBalance">₪0.00</div>
                </div>

                <div class="delete-all-container">
                    <button class="btn-delete-all-small" onclick="deleteAllData()">
                        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="3 6 5 6 21 6"></polyline><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path><line x1="10" y1="11" x2="10" y2="17"></line><line x1="14" y1="11" x2="14" y2="17"></line></svg>
                        מחק הכל
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal תנועה -->
    <div class="modal" id="transactionModal">
        <div class="modal-content">
            <div class="modal-header" id="modalTitle">הוספת תנועה</div>
            
            <div class="transaction-type-selector">
                <div class="type-option selected" id="typeRegular" onclick="selectTransactionType('regular')">
                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21.5 2v6h-6M2.5 22v-6h6M2 11.5a10 10 0 0 1 18.8-4.3M22 12.5a10 10 0 0 1-18.8 4.2"/></svg>
                    קבוע
                </div>
                <div class="type-option" id="typeVariable" onclick="selectTransactionType('variable')">
                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M3 3v18h18"/><path d="m19 9-5 5-4-4-3 3"/></svg>
                    משתנה
                </div>
                <div class="type-option" id="typeOnetime" onclick="selectTransactionType('onetime')">
                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polygon points="13 2 3 14 12 14 11 22 21 10 12 10 13 2"></polygon></svg>
                    חד-פעמי
                </div>
                <div class="type-option" id="typeLoan" onclick="selectTransactionType('loan')">
                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="2" y="4" width="20" height="16" rx="2"/><line x1="6" y1="12" x2="18" y2="12"/></svg>
                    הלוואה
                </div>
            </div>

            <div class="form-group">
                <label class="form-label">תיאור</label>
                <input type="text" class="form-input" id="descriptionInput" placeholder="למשל: משכורת, קניות...">
            </div>
            <div class="form-group">
                <label class="form-label" id="amountLabel">סכום (₪)</label>
                <input type="number" class="form-input" id="amountInput" placeholder="0.00" step="0.01">
            </div>

            <div class="loan-fields" id="loanFields">
                <div class="form-group">
                    <label class="form-label">סכום הלוואה מקורי (₪)</label>
                    <input type="number" class="form-input" id="loanOriginalAmountInput" placeholder="10000.00" step="0.01">
                </div>
                <div class="loan-row">
                    <div class="form-group" style="margin-bottom: 0;">
                        <label class="form-label">מספר תשלומים כולל</label>
                        <input type="number" class="form-input" id="loanTotalInput" placeholder="20" min="1">
                    </div>
                    <div class="form-group" style="margin-bottom: 0;">
                        <label class="form-label">תשלום נוכחי</label>
                        <input type="number" class="form-input" id="loanCurrentInput" placeholder="0" min="0">
                    </div>
                </div>
            </div>

            <div class="modal-actions">
                <button class="modal-btn modal-btn-save" onclick="saveTransaction()">שמור</button>
                <button class="modal-btn modal-btn-cancel" onclick="closeModal()">ביטול</button>
            </div>
        </div>
    </div>

    <!-- Modal גרף -->
    <div class="modal" id="chartModal">
        <div class="modal-content">
            <div class="modal-header" id="chartModalTitle">גרף התפלגות</div>
            <div class="chart-container">
                <canvas id="pieChart"></canvas>
            </div>
            <div class="modal-actions">
                <button class="modal-btn modal-btn-cancel" onclick="closeChartModal()">סגור</button>
            </div>
        </div>
    </div>

    <!-- Modal אישור -->
    <div class="modal" id="confirmModal">
        <div class="modal-content">
            <div class="modal-header" id="confirmModalTitle">אישור פעולה</div>
            <p id="confirmModalText"></p>
            <div class="modal-actions">
                <button class="modal-btn" id="confirmModalConfirmBtn">אשר</button>
                <button class="modal-btn modal-btn-cancel" onclick="closeConfirmModal()">ביטול</button>
            </div>
        </div>
    </div>

    <script>
        let transactions = {
            income: [],
            expenses: []
        };
        let currentType = 'income';
        let editingIndex = -1;
        let chartInstance = null;
        let currentBalanceValue = 0;
        let sortModeIncome = false;
        let sortModeExpense = false;
        let filterIncome = 'all';
        let filterExpense = 'all';

        function toggleLoanProgress(element) {
            const wrapper = element.closest('.transaction-wrapper');
            const progressBar = wrapper.querySelector('.loan-progress');
            if (progressBar) {
                progressBar.classList.toggle('visible');
            }
        }

        const themeIcons = {
            light: '<svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/></svg>',
            dark: '<svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"></path></svg>',
            auto: '<svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12 22a10 10 0 1 0 0-20 10 10 0 0 0 0 20Z"/><path d="M12 2a10 10 0 1 0 10 10"/></svg>'
        };

        function selectTransactionType(type) {
            if (type === 'loan' && currentType === 'income') {
                return;
            }
            
            selectedTransactionType = type;
            document.querySelectorAll('.type-option').forEach(el => el.classList.remove('selected'));
            
            const amountLabel = document.getElementById('amountLabel');
            const loanFields = document.getElementById('loanFields');

            if (type === 'loan') {
                document.getElementById('typeLoan').classList.add('selected');
                loanFields.classList.add('active');
                amountLabel.textContent = "סכום תשלום חודשי (₪)";
            } else {
                 if (type === 'regular') document.getElementById('typeRegular').classList.add('selected');
                 if (type === 'variable') document.getElementById('typeVariable').classList.add('selected');
                 if (type === 'onetime') document.getElementById('typeOnetime').classList.add('selected');
                 loanFields.classList.remove('active');
                 amountLabel.textContent = "סכום (₪)";
            }
        }

        function getSystemTheme() {
            return window.matchMedia('(prefers-color-scheme: dark)').matches ? 'dark' : 'light';
        }

        function loadTheme() {
            const savedTheme = localStorage.getItem('themePreference') || 'auto';
            applyTheme(savedTheme);
        }

        function applyTheme(theme) {
            const body = document.body;
            if (theme === 'auto') {
                const systemTheme = getSystemTheme();
                body.setAttribute('data-theme', systemTheme);
            } else {
                body.setAttribute('data-theme', theme);
            }
            updateThemeButton(theme);
        }

        function updateThemeButton(theme) {
            const themeIconContainer = document.getElementById('themeIconContainer');
            themeIconContainer.innerHTML = themeIcons[theme];
        }

        function cycleTheme() {
            const currentTheme = localStorage.getItem('themePreference') || 'auto';
            let newTheme;
            
            if (currentTheme === 'auto') {
                newTheme = 'light';
            } else if (currentTheme === 'light') {
                newTheme = 'dark';
            } else {
                newTheme = 'auto';
            }
            
            localStorage.setItem('themePreference', newTheme);
            applyTheme(newTheme);
        }

        window.matchMedia('(prefers-color-scheme: dark)').addEventListener('change', () => {
            const savedTheme = localStorage.getItem('themePreference') || 'auto';
            if (savedTheme === 'auto') {
                applyTheme('auto');
            }
        });

        function saveData() {
            localStorage.setItem('budgetData', JSON.stringify(transactions));
            localStorage.setItem('currentBalance', currentBalanceValue.toString());
        }

        function updateSummary() {
            const input = document.getElementById('currentBalanceInput');
            currentBalanceValue = parseFloat(input.value) || 0;
            
            const incomeTotal = transactions.income.reduce((sum, t) => sum + (t.checked ? t.amount : 0), 0);
            const expenseTotal = transactions.expenses.reduce((sum, t) => sum + (t.checked ? t.amount : 0), 0);
            
            const balanceAfterExpenses = currentBalanceValue - expenseTotal;
            const finalBalance = balanceAfterExpenses + incomeTotal;
            
            const afterExpensesEl = document.getElementById('balanceAfterExpenses');
            afterExpensesEl.textContent = '₪' + balanceAfterExpenses.toLocaleString('he-IL', {minimumFractionDigits: 2});
            afterExpensesEl.className = 'summary-row-value ' + (balanceAfterExpenses >= 0 ? 'positive' : 'negative');
            
            const finalBalanceEl = document.getElementById('finalBalance');
            finalBalanceEl.textContent = '₪' + finalBalance.toLocaleString('he-IL', {minimumFractionDigits: 2});
            finalBalanceEl.className = 'summary-row-value ' + (finalBalance >= 0 ? 'positive' : 'negative');
            
            const summaryCard = document.querySelector('.summary-card');
            summaryCard.classList.remove('alert-danger', 'alert-warning', 'alert-success');
            
            const alertIconDiv = document.getElementById('alertIcon');
             if (finalBalance < 0) {
                summaryCard.classList.add('alert-danger');
                if(alertIconDiv) alertIconDiv.innerHTML = '<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M10.29 3.86L1.82 18a2 2 0 0 0 1.71 3h16.94a2 2 0 0 0 1.71-3L13.71 3.86a2 2 0 0 0-3.42 0z"></path><line x1="12" y1="9" x2="12" y2="13"></line><line x1="12" y1="17" x2="12.01" y2="17"></line></svg>';
            } else if (finalBalance >= 0 && finalBalance <= 1000) {
                summaryCard.classList.add('alert-warning');
                if(alertIconDiv) alertIconDiv.innerHTML = '<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polygon points="13 2 3 14 12 14 11 22 21 10 12 10 13 2"></polygon></svg>';
            } else {
                summaryCard.classList.add('alert-success');
                if(alertIconDiv) alertIconDiv.innerHTML = '<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"></path><polyline points="22 4 12 14.01 9 11.01"></polyline></svg>';
            }

            saveData();
        }

        function updateLoansSummary() {
            const loanTransactions = transactions.expenses.filter(t => t.type === 'loan');
            const loansContent = document.getElementById('loansSummaryContent');
            const noLoansMessage = document.getElementById('noLoansMessage');
            
            const totalAmount = loanTransactions.reduce((sum, t) => sum + (t.originalLoanAmount || 0), 0);

            if (loanTransactions.length === 0) {
                if(loansContent) loansContent.style.display = 'none';
                if(noLoansMessage) noLoansMessage.style.display = 'block';
                document.getElementById('totalLoansCount').textContent = 0;
                document.getElementById('monthlyLoanPayment').textContent = `₪0.00`;
                document.getElementById('totalLoanAmount').textContent = `₪0.00`;
                document.getElementById('remainingLoanBalance').textContent = `₪0.00`;
                 document.getElementById('loansCollapsedSummary').innerHTML = `<span class="summary-label">אין הלוואות פעילות</span>`;

                return;
            }

            if(loansContent) loansContent.style.display = 'block';
            if(noLoansMessage) noLoansMessage.style.display = 'none';

            const activeLoansCount = loanTransactions.filter(t => t.loanCurrent < t.loanTotal).length;

            const monthlyPayment = loanTransactions.reduce((sum, t) => sum + t.amount, 0);


            const remainingBalance = loanTransactions.reduce((sum, t) => {
                const paidAmount = t.amount * t.loanCurrent;
                const remaining = (t.originalLoanAmount || 0) - paidAmount;
                return sum + (remaining > 0 ? remaining : 0);
            }, 0);

            document.getElementById('totalLoansCount').textContent = activeLoansCount;
            document.getElementById('monthlyLoanPayment').textContent = `₪${monthlyPayment.toLocaleString('he-IL', {minimumFractionDigits: 2})}`;
            document.getElementById('totalLoanAmount').textContent = `₪${totalAmount.toLocaleString('he-IL', {minimumFractionDigits: 2})}`;
            document.getElementById('remainingLoanBalance').textContent = `₪${remainingBalance.toLocaleString('he-IL', {minimumFractionDigits: 2})}`;
             document.getElementById('loansCollapsedSummary').innerHTML = `<span class="summary-label">סך הלוואות:</span> <span class="summary-value">₪${totalAmount.toLocaleString('he-IL', {minimumFractionDigits: 2})}</span>`;

        }

        function updateBalanceIndicator() {
            const titleElement = document.querySelector('.header h1');
            const indicator = document.getElementById('balanceIndicator');

            // Use only CHECKED transactions for the main balance indicator
            const totalIncome = transactions.income.reduce((sum, t) => sum + (t.checked ? t.amount : 0), 0);
            const totalExpenses = transactions.expenses.reduce((sum, t) => sum + (t.checked ? t.amount : 0), 0);

            // Update title stroke
            titleElement.classList.remove('title-positive-balance', 'title-negative-balance');
            if (totalIncome > totalExpenses) {
                titleElement.classList.add('title-positive-balance');
            } else if (totalExpenses > totalIncome) {
                titleElement.classList.add('title-negative-balance');
            }

            // Update scale position
            const total = totalIncome + totalExpenses;
            let incomeRatio = 0.5; // Default to center if no transactions
            if (total > 0) {
                incomeRatio = totalIncome / total;
            }
            
            // Position from the left. High income ratio = closer to 0% (left/green side)
            indicator.style.left = `${(1-incomeRatio) * 100}%`;
        }


        function toggleSortMode(type) {
            if (type === 'income') {
                sortModeIncome = !sortModeIncome;
                const btn = document.getElementById('sortBtnIncome');
                if (sortModeIncome) {
                    btn.classList.add('active');
                } else {
                    btn.classList.remove('active');
                }
            } else {
                sortModeExpense = !sortModeExpense;
                const btn = document.getElementById('sortBtnExpense');
                if (sortModeExpense) {
                    btn.classList.add('active');
                } else {
                    btn.classList.remove('active');
                }
            }
            render();
        }

        function loadData() {
            const saved = localStorage.getItem('budgetData');
            if (saved) {
                transactions = JSON.parse(saved);
            }
            
            const savedBalance = localStorage.getItem('currentBalance');
            if (savedBalance) {
                currentBalanceValue = parseFloat(savedBalance);
                document.getElementById('currentBalanceInput').value = currentBalanceValue;
            }
            
            loadFilters();
            render();
        }

        function loadFilters() {
            filterIncome = localStorage.getItem('incomeFilter') || 'all';
            filterExpense = localStorage.getItem('expenseFilter') || 'all';

            document.querySelectorAll('#filterDropdownIncome .filter-option').forEach(opt => {
                if(opt.dataset.filter === filterIncome) opt.classList.add('selected');
                else opt.classList.remove('selected');
            });
            document.querySelectorAll('#filterDropdownExpense .filter-option').forEach(opt => {
                if(opt.dataset.filter === filterExpense) opt.classList.add('selected');
                else opt.classList.remove('selected');
            });
        }


        function moveItem(event, type, index, direction) {
            event.stopPropagation();
            const arr = type === 'income' ? transactions.income : transactions.expenses;
            
            if (direction === 'up' && index > 0) {
                [arr[index], arr[index - 1]] = [arr[index - 1], arr[index]];
            } else if (direction === 'down' && index < arr.length - 1) {
                [arr[index], arr[index + 1]] = [arr[index + 1], arr[index]];
            }
            
            saveData();
            render();
        }

        function nextLoanPayment(event, type, index) {
            event.stopPropagation();
            const transactionList = type === 'income' ? transactions.income : transactions.expenses;
            const transaction = transactionList[index];
            
            if (transaction.type === 'loan' && transaction.loanCurrent < transaction.loanTotal) {
                transaction.loanCurrent++;
                saveData();

                // Update the DOM directly instead of re-rendering the whole list
                const wrapper = event.target.closest('.transaction-wrapper');
                if (wrapper) {
                    const progressBarFill = wrapper.querySelector('.progress-bar-fill');
                    const progressText = wrapper.querySelector('.progress-text');
                    
                    const percentage = (transaction.loanCurrent / transaction.loanTotal) * 100;
                    const amountPaid = transaction.amount * transaction.loanCurrent;
                    
                    if(progressBarFill) {
                        progressBarFill.style.width = `${percentage}%`;
                    }
                    if(progressText) {
                        progressText.textContent = `${transaction.loanCurrent}/${transaction.loanTotal} (${percentage.toFixed(0)}%) · ₪${amountPaid.toLocaleString('he-IL')} שולמו`;
                    }

                    if (transaction.loanCurrent >= transaction.loanTotal) {
                        const button = event.target.closest('button');
                        if (button) {
                            button.disabled = true;
                            button.title = 'ההלוואה שולמה במלואה';
                            button.innerHTML = '<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3" stroke-linecap="round" stroke-linejoin="round"><polyline points="20 6 9 17 4 12"></polyline></svg>';
                        }
                    }
                }
                 updateLoansSummary();
            }
        }

        function toggleFilter(type) {
            const dropdown = document.getElementById(type === 'income' ? 'filterDropdownIncome' : 'filterDropdownExpense');
            const btn = document.getElementById(type === 'income' ? 'filterBtnIncome' : 'filterBtnExpense');
            
            dropdown.classList.toggle('active');
            btn.classList.toggle('active');
        }

        function setFilter(type, filter, shouldRender = true) {
            let dropdownId, btnId;
            if (type === 'income') {
                filterIncome = filter;
                dropdownId = 'filterDropdownIncome';
                btnId = 'filterBtnIncome';
            } else {
                filterExpense = filter;
                dropdownId = 'filterDropdownExpense';
                btnId = 'filterBtnExpense';
            }

            localStorage.setItem(`${type}Filter`, filter);

            const dropdown = document.getElementById(dropdownId);
            const btn = document.getElementById(btnId);
            if (dropdown) dropdown.classList.remove('active');
            if (btn) btn.classList.remove('active');
            
            document.querySelectorAll(`#${dropdownId} .filter-option`).forEach(opt => {
                opt.classList.remove('selected');
            });

            const selectedOption = document.querySelector(`#${dropdownId} [data-filter="${filter}"]`);
            if (selectedOption) {
                selectedOption.classList.add('selected');
            }
            
            if (shouldRender) {
                render();
            }
        }

        document.addEventListener('click', (e) => {
            if (!e.target.closest('.dropdown-container')) {
                const incomeDropdown = document.getElementById('filterDropdownIncome');
                const expenseDropdown = document.getElementById('filterDropdownExpense');
                if(incomeDropdown) incomeDropdown.classList.remove('active');
                if(expenseDropdown) expenseDropdown.classList.remove('active');

                const incomeBtn = document.getElementById('filterBtnIncome');
                const expenseBtn = document.getElementById('filterBtnExpense');
                if(incomeBtn) incomeBtn.classList.remove('active');
                if(expenseBtn) expenseBtn.classList.remove('active');
            }
        });

        function exportData() {
            const dataStr = JSON.stringify(transactions, null, 2);
            const dataBlob = new Blob([dataStr], { type: 'application/json' });
            const url = URL.createObjectURL(dataBlob);
            const link = document.createElement('a');
            link.href = url;
            link.download = `budget-${new Date().toISOString().split('T')[0]}.json`;
            link.click();
            URL.revokeObjectURL(url);
        }

        function importData(event) {
            const file = event.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    try {
                        const imported = JSON.parse(e.target.result);
                        openConfirmModal('אישור ייבוא נתונים', 'האם לייבא את הנתונים? הנתונים הנוכחיים יוחלפו.', () => {
                            transactions = imported;
                            saveData();
                            render();
                            closeConfirmModal();
                        });
                    } catch (error) {
                       openConfirmModal('שגיאה', 'אירעה שגיאה בקריאת הקובץ.', closeConfirmModal);
                    }
                };
                reader.readAsText(file);
            }
            event.target.value = '';
        }

        function showChart(type) {
            const data = type === 'income' ? transactions.income : transactions.expenses;
            
            if (data.length === 0) {
                openConfirmModal('מידע', 'אין נתונים להצגה בגרף.', closeConfirmModal);
                return;
            }

            const checkedData = data.filter(t => t.checked);
            if (checkedData.length === 0) {
                openConfirmModal('מידע', 'אין פריטים מסומנים להצגה בגרף.', closeConfirmModal);
                return;
            }

            const modal = document.getElementById('chartModal');
            const title = document.getElementById('chartModalTitle');
            
            title.textContent = type === 'income' ? 'התפלגות הכנסות' : 'התפלגות הוצאות';
            modal.classList.add('active');

            const labels = checkedData.map(t => t.description);
            const amounts = checkedData.map(t => t.amount);
            const colors = generateColors(checkedData.length);

            const ctx = document.getElementById('pieChart').getContext('2d');
            
            if (chartInstance) {
                chartInstance.destroy();
            }

            chartInstance = new Chart(ctx, {
                type: 'pie',
                data: {
                    labels: labels,
                    datasets: [{
                        data: amounts,
                        backgroundColor: colors,
                        borderWidth: 2,
                        borderColor: getComputedStyle(document.body).getPropertyValue('--card-bg')
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'bottom',
                            labels: {
                                padding: 15,
                                font: {
                                    size: 14
                                },
                                color: getComputedStyle(document.body).getPropertyValue('--text-primary')
                            }
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    const label = context.label || '';
                                    const value = context.parsed;
                                    const total = context.dataset.data.reduce((a, b) => a + b, 0);
                                    const percentage = ((value / total) * 100).toFixed(1);
                                    return `${label}: ₪${value.toLocaleString('he-IL')} (${percentage}%)`;
                                }
                            }
                        }
                    }
                }
            });
        }

        function generateColors(count) {
            const colors = [
                '#10b981', '#3b82f6', '#f59e0b', '#ef4444', '#8b5cf6',
                '#ec4899', '#14b8a6', '#f97316', '#06b6d4', '#84cc16'
            ];
            return colors.slice(0, count);
        }

        function closeChartModal() {
            document.getElementById('chartModal').classList.remove('active');
            if (chartInstance) {
                chartInstance.destroy();
                chartInstance = null;
            }
        }

        function deleteAllData() {
            const incomeCount = transactions.income.length;
            const expenseCount = transactions.expenses.length;
            const totalItems = incomeCount + expenseCount;

            if (totalItems === 0) {
                return;
            }

            const message = `אתה עומד למחוק את כל הנתונים לצמיתות.<br><br>` +
                          `<b>סה"כ למחיקה:</b><br>` +
                          `• ${incomeCount} הכנסות<br>` +
                          `• ${expenseCount} הוצאות<br><br>` +
                          `האם אתה בטוח שברצונך להמשיך?`;

            openConfirmModal('אישור מחיקת כל הנתונים', message, () => {
                transactions = {
                    income: [],
                    expenses: []
                };
                saveData();
                render();
                closeConfirmModal();
            });
        }

        function openModal(event, type, index = -1) {
            if (typeof event === 'string') {
                // Handle call from add button like openModal('income')
                type = event;
                index = -1;
            } else if (event) {
                // Handle call from edit button like openModal(event, 'income', i)
                event.stopPropagation();
            }
            
            currentType = type;
            editingIndex = index;
            
            const modal = document.getElementById('transactionModal');
            const title = document.getElementById('modalTitle');
            const descInput = document.getElementById('descriptionInput');
            const amountInput = document.getElementById('amountInput');
            const loanOriginalAmountInput = document.getElementById('loanOriginalAmountInput');
            const loanTotalInput = document.getElementById('loanTotalInput');
            const loanCurrentInput = document.getElementById('loanCurrentInput');
            const loanBtn = document.getElementById('typeLoan');

            if (type === 'income') {
                loanBtn.classList.add('disabled');
                loanBtn.title = 'הלוואה זמינה רק בהוצאות';
            } else {
                loanBtn.classList.remove('disabled');
                loanBtn.title = '';
            }

            if (index >= 0) {
                const transaction = type === 'income' ? transactions.income[index] : transactions.expenses[index];
                title.textContent = 'עריכת תנועה';
                descInput.value = transaction.description;
                amountInput.value = transaction.amount;
                selectTransactionType(transaction.type || 'regular');
                
                if (transaction.type === 'loan') {
                    loanOriginalAmountInput.value = transaction.originalLoanAmount || '';
                    loanTotalInput.value = transaction.loanTotal || '';
                    loanCurrentInput.value = transaction.loanCurrent || '';
                }
            } else {
                title.textContent = type === 'income' ? 'הוספת הכנסה' : 'הוספת הוצאה';
                descInput.value = '';
                amountInput.value = '';
                loanOriginalAmountInput.value = '';
                loanTotalInput.value = '';
                loanCurrentInput.value = '';
                selectTransactionType('regular');
            }

            modal.classList.add('active');
            descInput.focus();
        }

        function closeModal() {
            document.getElementById('transactionModal').classList.remove('active');
        }

        function saveTransaction() {
            const description = document.getElementById('descriptionInput').value.trim();
            const amount = parseFloat(document.getElementById('amountInput').value); // This is now monthly amount

            if (!description || !amount || amount <= 0) {
                openConfirmModal('שגיאה', 'נא למלא תיאור וסכום חיובי.', closeConfirmModal);
                return;
            }

            const transaction = {
                id: Date.now(),
                description,
                amount,
                checked: true,
                type: selectedTransactionType
            };

            if (selectedTransactionType === 'loan') {
                const originalLoanAmount = parseFloat(document.getElementById('loanOriginalAmountInput').value);
                const loanTotal = parseInt(document.getElementById('loanTotalInput').value);
                const loanCurrent = parseInt(document.getElementById('loanCurrentInput').value);
                
                if (!originalLoanAmount || !loanTotal || Number.isNaN(loanCurrent) || originalLoanAmount <=0 || loanTotal < 1 || loanCurrent < 0 || loanCurrent > loanTotal) {
                    openConfirmModal('שגיאה', 'נא למלא את כל פרטי ההלוואה באופן תקין.', closeConfirmModal);
                    return;
                }

                if (amount > originalLoanAmount) {
                    openConfirmModal('שגיאה', 'הסכום החודשי אינו יכול להיות גבוה מסכום ההלוואה המקורי.', closeConfirmModal);
                    return;
                }
                
                transaction.originalLoanAmount = originalLoanAmount;
                transaction.loanTotal = loanTotal;
                transaction.loanCurrent = loanCurrent;
            }

            if (editingIndex >= 0) {
                if (currentType === 'income') {
                    transactions.income[editingIndex] = { ...transactions.income[editingIndex], ...transaction };
                } else {
                    transactions.expenses[editingIndex] = { ...transactions.expenses[editingIndex], ...transaction };
                }
            } else {
                if (currentType === 'income') {
                    transactions.income.push(transaction);
                } else {
                    transactions.expenses.push(transaction);
                }
            }

            saveData();
            render();
            closeModal();
        }

        function deleteTransaction(event, type, index) {
            event.stopPropagation();
            const transaction = type === 'income' ? transactions.income[index] : transactions.expenses[index];
            const message = `האם אתה בטוח שברצונך למחוק את התנועה?<br><br><b>"${transaction.description}"</b> בסך <b>₪${transaction.amount.toLocaleString('he-IL')}</b>`;

            openConfirmModal('אישור מחיקת תנועה', message, () => {
                 if (type === 'income') {
                    transactions.income.splice(index, 1);
                } else {
                    transactions.expenses.splice(index, 1);
                }
                saveData();
                render();
                closeConfirmModal();
            });
        }

        function toggleCheck(event, type, index) {
            event.stopPropagation();
            if (type === 'income') {
                transactions.income[index].checked = !transactions.income[index].checked;
            } else {
                transactions.expenses[index].checked = !transactions.expenses[index].checked;
            }
            saveData();
            render();
        }

        function render() {
            let filteredIncome = transactions.income;
            if (filterIncome === 'active') {
                filteredIncome = transactions.income.filter(t => t.checked);
            } else if (filterIncome === 'inactive') {
                filteredIncome = transactions.income.filter(t => !t.checked);
            } else if (filterIncome !== 'all') {
                filteredIncome = transactions.income.filter(t => t.type === filterIncome);
            }
            
            const incomeList = document.getElementById('incomeList');
            incomeList.innerHTML = filteredIncome.length === 0 
                ? '<div class="empty-state">אין הכנסות להצגה</div>'
                : filteredIncome.map((t) => {
                    const i = transactions.income.indexOf(t);
                    let badgeClass, badgeText;
                    if (t.type === 'loan') {
                        badgeClass = 'badge-loan';
                        badgeText = 'הלוואה';
                    } else if (t.type === 'variable') {
                        badgeClass = 'badge-variable';
                        badgeText = 'משתנה';
                    } else if (t.type === 'onetime') {
                        badgeClass = 'badge-onetime';
                        badgeText = 'חד-פעמי';
                    } else {
                        badgeClass = 'badge-regular';
                        badgeText = 'קבוע';
                    }
                    
                    let loanDetails = '';
                    if (t.type === 'loan' && t.originalLoanAmount) {
                        loanDetails = `<div class="loan-original-amount">סכום הלוואה: ₪${t.originalLoanAmount.toLocaleString('he-IL')}</div>`;
                    }
                    
                    let progressBar = '';
                    if (t.type === 'loan' && t.loanTotal && typeof t.loanCurrent === 'number') {
                        const percentage = (t.loanCurrent / t.loanTotal) * 100;
                        const amountPaid = t.amount * t.loanCurrent;
                        const isComplete = t.loanCurrent >= t.loanTotal;
                        progressBar = `
                            <div class="loan-progress">
                                <div class="loan-progress-container">
                                    <div class="progress-bar-container">
                                        <div class="progress-bar-fill" style="width: ${percentage}%"></div>
                                    </div>
                                    <div class="progress-text">${t.loanCurrent}/${t.loanTotal} (${percentage.toFixed(0)}%) · ₪${amountPaid.toLocaleString('he-IL')} שולמו</div>
                                </div>
                                <button class="loan-next-payment-btn" 
                                        onclick="nextLoanPayment(event, 'income', ${i})"
                                        ${isComplete ? 'disabled' : ''}
                                        title="${isComplete ? 'ההלוואה שולמה במלואה' : 'הוסף תשלום'}">
                                     ${isComplete 
                                         ? '<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3" stroke-linecap="round" stroke-linejoin="round"><polyline points="20 6 9 17 4 12"></polyline></svg>' 
                                         : '<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3" stroke-linecap="round" stroke-linejoin="round"><line x1="12" y1="5" x2="12" y2="19"></line><line x1="5" y1="12" x2="19" y2="12"></line></svg>'
                                     }
                                </button>
                            </div>
                        `;
                    }

                    const itemHTML = `
                        <div class="transaction-info">
                            <div class="transaction-check ${t.checked ? 'checked' : ''}" 
                                 onclick="toggleCheck(event, 'income', ${i})">
                                 <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3" stroke-linecap="round" stroke-linejoin="round"><polyline points="20 6 9 17 4 12"></polyline></svg>
                            </div>
                             <div class="transaction-details">
                                <div class="transaction-text">
                                    ${t.description}
                                    <span class="transaction-badge ${badgeClass}">${badgeText}</span>
                                </div>
                                ${loanDetails}
                            </div>
                        </div>
                        <div class="transaction-amount">₪${t.amount.toLocaleString('he-IL', {minimumFractionDigits: 2})}</div>
                        <div class="item-controls">
                            <div class="sort-buttons ${sortModeIncome ? 'visible' : ''}">
                                <button class="sort-btn" onclick="moveItem(event, 'income', ${i}, 'up')" ${i === 0 ? 'disabled' : ''} title="הזז למעלה"><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><polyline points="18 15 12 9 6 15"></polyline></svg></button>
                                <button class="sort-btn" onclick="moveItem(event, 'income', ${i}, 'down')" ${i === transactions.income.length - 1 ? 'disabled' : ''} title="הזז למטה"><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><polyline points="6 9 12 15 18 9"></polyline></svg></button>
                            </div>
                            <div class="transaction-actions">
                                <button class="action-btn edit" onclick="openModal(event, 'income', ${i})" title="עריכה">
                                    <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M17 3a2.828 2.828 0 1 1 4 4L7.5 20.5 2 22l1.5-5.5L17 3z"></path></svg>
                                </button>
                                <button class="action-btn delete" onclick="deleteTransaction(event, 'income', ${i})" title="מחיקה">
                                    <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="3 6 5 6 21 6"></polyline><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path><line x1="10" y1="11" x2="10" y2="17"></line><line x1="14" y1="11" x2="14" y2="17"></line></svg>
                                </button>
                            </div>
                        </div>
                    `;
                    
                    if (t.type === 'loan') {
                         return `
                         <div class="transaction-wrapper">
                            <div class="transaction-item loan-item ${!t.checked ? 'inactive' : ''}" onclick="toggleLoanProgress(this)">
                                ${itemHTML}
                            </div>
                            ${progressBar}
                        </div>`;
                    } else {
                        return `
                        <div class="transaction-wrapper">
                            <div class="transaction-item ${!t.checked ? 'inactive' : ''}">
                                ${itemHTML}
                            </div>
                        </div>`;
                    }
                }).join('');

            let filteredExpenses = transactions.expenses;
            if (filterExpense === 'active') {
                filteredExpenses = transactions.expenses.filter(t => t.checked);
            } else if (filterExpense === 'inactive') {
                filteredExpenses = transactions.expenses.filter(t => !t.checked);
            } else if (filterExpense !== 'all') {
                filteredExpenses = transactions.expenses.filter(t => t.type === filterExpense);
            }

            const expenseList = document.getElementById('expenseList');
            expenseList.innerHTML = filteredExpenses.length === 0
                ? '<div class="empty-state">אין הוצאות להצגה</div>'
                : filteredExpenses.map((t) => {
                    const i = transactions.expenses.indexOf(t);
                    let badgeClass, badgeText;
                    if (t.type === 'loan') {
                        badgeClass = 'badge-loan';
                        badgeText = 'הלוואה';
                    } else if (t.type === 'variable') {
                        badgeClass = 'badge-variable';
                        badgeText = 'משתנה';
                    } else if (t.type === 'onetime') {
                        badgeClass = 'badge-onetime';
                        badgeText = 'חד-פעמי';
                    } else {
                        badgeClass = 'badge-regular';
                        badgeText = 'קבוע';
                    }
                    
                    let loanDetails = '';
                    if (t.type === 'loan' && t.originalLoanAmount) {
                        loanDetails = `<div class="loan-original-amount">סכום הלוואה: ₪${t.originalLoanAmount.toLocaleString('he-IL')}</div>`;
                    }
                    
                    let progressBar = '';
                    if (t.type === 'loan' && t.loanTotal && typeof t.loanCurrent === 'number') {
                        const percentage = (t.loanCurrent / t.loanTotal) * 100;
                        const amountPaid = t.amount * t.loanCurrent;
                        const isComplete = t.loanCurrent >= t.loanTotal;
                        progressBar = `
                            <div class="loan-progress">
                                <div class="loan-progress-container">
                                    <div class="progress-bar-container">
                                        <div class="progress-bar-fill" style="width: ${percentage}%"></div>
                                    </div>
                                    <div class="progress-text">${t.loanCurrent}/${t.loanTotal} (${percentage.toFixed(0)}%) · ₪${amountPaid.toLocaleString('he-IL')} שולמו</div>
                                </div>
                                <button class="loan-next-payment-btn" 
                                        onclick="nextLoanPayment(event, 'expense', ${i})"
                                        ${isComplete ? 'disabled' : ''}
                                        title="${isComplete ? 'ההלוואה שולמה במלואה' : 'הוסף תשלום'}">
                                     ${isComplete 
                                         ? '<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3" stroke-linecap="round" stroke-linejoin="round"><polyline points="20 6 9 17 4 12"></polyline></svg>' 
                                         : '<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3" stroke-linecap="round" stroke-linejoin="round"><line x1="12" y1="5" x2="12" y2="19"></line><line x1="5" y1="12" x2="19" y2="12"></line></svg>'
                                     }
                                </button>
                            </div>
                        `;
                    }
                    
                    const itemHTML = `
                        <div class="transaction-info">
                            <div class="transaction-check ${t.checked ? 'checked' : ''}" 
                                 onclick="toggleCheck(event, 'expense', ${i})">
                                 <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3" stroke-linecap="round" stroke-linejoin="round"><polyline points="20 6 9 17 4 12"></polyline></svg>
                            </div>
                            <div class="transaction-details">
                                <div class="transaction-text">
                                    ${t.description}
                                    <span class="transaction-badge ${badgeClass}">${badgeText}</span>
                                </div>
                                ${loanDetails}
                            </div>
                        </div>
                        <div class="transaction-amount">₪${t.amount.toLocaleString('he-IL', {minimumFractionDigits: 2})}</div>
                        <div class="item-controls">
                            <div class="sort-buttons ${sortModeExpense ? 'visible' : ''}">
                                <button class="sort-btn" onclick="moveItem(event, 'expense', ${i}, 'up')" ${i === 0 ? 'disabled' : ''} title="הזז למעלה"><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><polyline points="18 15 12 9 6 15"></polyline></svg></button>
                                <button class="sort-btn" onclick="moveItem(event, 'expense', ${i}, 'down')" ${i === transactions.expenses.length - 1 ? 'disabled' : ''} title="הזז למטה"><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><polyline points="6 9 12 15 18 9"></polyline></svg></button>
                            </div>
                            <div class="transaction-actions">
                               <button class="action-btn edit" onclick="openModal(event, 'expense', ${i})" title="עריכה">
                                    <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M17 3a2.828 2.828 0 1 1 4 4L7.5 20.5 2 22l1.5-5.5L17 3z"></path></svg>
                                </button>
                                <button class="action-btn delete" onclick="deleteTransaction(event, 'expense', ${i})" title="מחיקה">
                                    <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="3 6 5 6 21 6"></polyline><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path><line x1="10" y1="11" x2="10" y2="17"></line><line x1="14" y1="11" x2="14" y2="17"></line></svg>
                                </button>
                            </div>
                        </div>
                    `;
                    
                    if (t.type === 'loan') {
                         return `
                         <div class="transaction-wrapper">
                            <div class="transaction-item loan-item ${!t.checked ? 'inactive' : ''}" onclick="toggleLoanProgress(this)">
                                ${itemHTML}
                            </div>
                            ${progressBar}
                        </div>`;
                    } else {
                        return `
                        <div class="transaction-wrapper">
                            <div class="transaction-item ${!t.checked ? 'inactive' : ''}">
                                ${itemHTML}
                            </div>
                        </div>`;
                    }
                }).join('');

            const incomeTotal = filteredIncome.reduce((sum, t) => sum + (t.checked ? t.amount : 0), 0);
            const expenseTotal = filteredExpenses.reduce((sum, t) => sum + (t.checked ? t.amount : 0), 0);
            const finalBalance = (currentBalanceValue || 0) - expenseTotal + incomeTotal;


            let incomeLabelText = 'סה״כ הכנסות';
            switch (filterIncome) {
                case 'regular':
                    incomeLabelText = 'סה״כ קבועות';
                    break;
                case 'variable':
                    incomeLabelText = 'סה״כ משתנות';
                    break;
                case 'onetime':
                    incomeLabelText = 'סה״כ חד-פעמיות';
                    break;
                case 'active':
                    incomeLabelText = 'סה״כ פעילות';
                    break;
                case 'inactive':
                    incomeLabelText = 'סה״כ לא פעילות';
                    break;
            }
            document.getElementById('incomeTotalLabel').textContent = incomeLabelText;
            document.getElementById('incomeCollapsedSummary').innerHTML = `<span class="summary-label">${incomeLabelText}:</span> <span class="summary-value">₪${incomeTotal.toLocaleString('he-IL', {minimumFractionDigits: 2})}</span>`;

            let expenseLabelText = 'סה״כ הוצאות';
            switch (filterExpense) {
                case 'regular':
                    expenseLabelText = 'סה״כ קבועות';
                    break;
                case 'variable':
                    expenseLabelText = 'סה״כ משתנות';
                    break;
                case 'onetime':
                    expenseLabelText = 'סה״כ חד-פעמיות';
                    break;
                case 'loan':
                    expenseLabelText = 'סה״כ הלוואות';
                    break;
                case 'active':
                    expenseLabelText = 'סה״כ פעילות';
                    break;
                case 'inactive':
                    expenseLabelText = 'סה״כ לא פעילות';
                    break;
            }
            document.getElementById('expenseTotalLabel').textContent = expenseLabelText;
            document.getElementById('expenseCollapsedSummary').innerHTML = `<span class="summary-label">${expenseLabelText}:</span> <span class="summary-value">₪${expenseTotal.toLocaleString('he-IL', {minimumFractionDigits: 2})}</span>`;

            
            const finalBalanceValueString = `₪${finalBalance.toLocaleString('he-IL', {minimumFractionDigits: 2})}`;
            const finalBalanceClass = finalBalance >= 0 ? 'positive' : 'negative';
            document.getElementById('summaryCollapsedSummary').innerHTML = `<span class="summary-label">עו"ש סופי:</span> <span class="summary-value ${finalBalanceClass}">${finalBalanceValueString}</span>`;


            document.getElementById('incomeTotal').textContent = 
                '₪' + incomeTotal.toLocaleString('he-IL', {minimumFractionDigits: 2});
            document.getElementById('expenseTotal').textContent = 
                '₪' + expenseTotal.toLocaleString('he-IL', {minimumFractionDigits: 2});
            
            const incomeChartBtn = document.querySelector('.income-card .chart-btn');
            const incomeSortBtn = document.querySelector('.income-card .sort-mode-btn');
            const expenseChartBtn = document.querySelector('.expense-card .chart-btn');
            const expenseSortBtn = document.querySelector('.expense-card .sort-mode-btn');

            if (filterIncome !== 'all') {
                incomeChartBtn.disabled = true;
                incomeSortBtn.disabled = true;
                incomeChartBtn.title = "האפשרות זמינה רק במצב 'הצג הכל'";
                incomeSortBtn.title = "האפשרות זמינה רק במצב 'הצג הכל'";
            } else {
                incomeChartBtn.disabled = false;
                incomeSortBtn.disabled = false;
                incomeChartBtn.title = "הצג גרף";
                incomeSortBtn.title = "סידור";
            }

            if (filterExpense !== 'all') {
                expenseChartBtn.disabled = true;
                expenseSortBtn.disabled = true;
                expenseChartBtn.title = "האפשרות זמינה רק במצב 'הצג הכל'";
                expenseSortBtn.title = "האפשרות זמינה רק במצב 'הצג הכל'";
            } else {
                expenseChartBtn.disabled = false;
                expenseSortBtn.disabled = false;
                expenseChartBtn.title = "הצג גרף";
                expenseSortBtn.title = "סידור";
            }
            
            updateBalanceIndicator();
            updateLoansSummary();
            updateSummary();
        }

        document.addEventListener('DOMContentLoaded', () => {
            loadTheme();
            loadData();
            loadCardStates();

            document.querySelectorAll('.filter-option').forEach(option => {
                option.addEventListener('click', (e) => {
                    const dropdown = e.target.closest('.filter-dropdown');
                    const type = dropdown.id.includes('Income') ? 'income' : 'expense';
                    const filter = e.target.closest('.filter-option').dataset.filter;
                    setFilter(type, filter);
                });
            });

            document.addEventListener('keydown', (e) => {
                if (e.key === 'Escape') {
                    closeModal();
                    closeChartModal();
                    closeConfirmModal();
                }
            });

            document.getElementById('transactionModal').addEventListener('click', (e) => {
                if (e.target.id === 'transactionModal') closeModal();
            });

            document.getElementById('chartModal').addEventListener('click', (e) => {
                if (e.target.id === 'chartModal') closeChartModal();
            });

            document.getElementById('confirmModal').addEventListener('click', (e) => {
                if (e.target.id === 'confirmModal') closeConfirmModal();
            });
        });


        function openConfirmModal(title, text, onConfirm) {
            document.getElementById('confirmModalTitle').textContent = title;
            document.getElementById('confirmModalText').innerHTML = text; 
            
            const confirmBtn = document.getElementById('confirmModalConfirmBtn');
            const newConfirmBtn = confirmBtn.cloneNode(true);
            confirmBtn.parentNode.replaceChild(newConfirmBtn, confirmBtn);
            
            newConfirmBtn.addEventListener('click', onConfirm);
            
            if (title === 'שגיאה' || title === 'מידע') {
                 newConfirmBtn.style.display = 'none';
                 document.querySelector('#confirmModal .modal-btn-cancel').textContent = 'סגור';
            } else {
                 newConfirmBtn.style.display = 'flex';
                 newConfirmBtn.textContent = 'אשר';
                 document.querySelector('#confirmModal .modal-btn-cancel').textContent = 'ביטול';
            }

            document.getElementById('confirmModal').classList.add('active');
        }

        function closeConfirmModal() {
            document.getElementById('confirmModal').classList.remove('active');
        }

        function toggleCard(button, cardName) {
            const card = button.closest('.card');
            card.classList.toggle('is-collapsed');
            button.classList.toggle('collapsed');

            if (card.classList.contains('is-collapsed')) {
                localStorage.setItem(cardName + 'CardState', 'collapsed');
            } else {
                localStorage.setItem(cardName + 'CardState', 'expanded');
            }
        }

        function loadCardStates() {
            const cards = ['income', 'expense', 'loansSummary', 'summary'];
            cards.forEach(cardName => {
                const savedState = localStorage.getItem(cardName + 'CardState');
                if (savedState === 'collapsed') {
                    const card = document.querySelector('.'+cardName.replace('Summary', '-summary')+'-card');
                    const button = card.querySelector('.collapse-btn');
                    if (card) card.classList.add('is-collapsed');
                    if (button) button.classList.add('collapsed');
                }
            });
        }
    </script>
</body>
</html>







